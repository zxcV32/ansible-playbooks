---
- name: Install orchestrator packages
  hosts:
    orchestrator
  tasks:
  - name: Pulling orchestration images
    shell: kubeadm config images pull
  - name: Reset kubeadm
    shell: kubeadm reset -f
    register: output
  - name: Initialze orchestrator
    shell: kubeadm init
    register: output
  - name: Store Logs and cluster joining token
    become: False
    copy:
      src: "{{ output.stdout }}"
      dest: "/home/{{ ansible_user }}/orchestrator.log"
  - name: Creating config
    become: False
    shell: |
     mkdir -p $HOME/.kube
     sudo cp -f /etc/kubernetes/admin.conf $HOME/.kube/config
     sudo chown $(id -u):$(id -g) $HOME/.kube/config
  - name: Deploy pod nework
    command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
  - name: Deploy pod network
    command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/k8s-manifests/kube-flannel-rbac.yml
